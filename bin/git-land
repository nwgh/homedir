#!/usr/bin/env python

import argparse
import glob
import os
import shutil
import subprocess
import sys
import tempfile

class GitPusherException(Exception):
    def __init__(self, msg):
        self.msg = msg

    def __str__(self):
        return self.msg

class GitPusher(object):
    def __init__(self, args):
        self._parse_args(args)
        self.tmpdir = None
        self.patches = None

        p = subprocess.Popen(['git', 'config', '--get',
                              '%s.repo' % (self.args.repo,)],
                             stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        p.wait()
        self.repo = p.stdout.read().strip()
        if not self.repo:
            raise GitPusherException('Missing path to HG repo')

        p = subprocess.Popen(['git', 'config', '--get',
                              '%s.interactive' % (self.args.repo,)],
                             stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        p.wait()
        interactive = p.stdout.read().strip().lower()
        self.interactive = interactive not in ['0', 'no', 'f', 'false']

        p = subprocess.Popen(['git', 'config', '--get',
                              '%s.url' % (self.args.repo,)],
                             stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        p.wait()
        self.url = p.stdout.read().strip()

    def _parse_args(self, args):
        parser = argparse.ArgumentParser(prog='git land')
        parser.add_argument('-b', '--build', action='append',
                            help='Build type to make')
        parser.add_argument('-p', '--platform', action='append',
                            help='Platforms to build')
        parser.add_argument('-u', '--unittests', action='append',
                            help='Unit tests to run')
        parser.add_argument('-t', '--talos', action='append',
                            help='Talos tests to run')
        parser.add_argument('-e', '--all-emails', action='store_true',
                            help='Send all emails')
        parser.add_argument('-n', '--no-emails', action='store_true',
                            help='Send no email')
        parser.add_argument('-f', '--failure-emails', action='store_true',
                            help='Send only failure emails')
        parser.add_argument('-m', '--mozilla-central', action='store_true',
                            help='Use mozilla-central configuration')
        parser.add_argument('--force', action='store_true',
                            help='Force push (only for pushes to try)')
        parser.add_argument('repo', nargs='?', default='try',
                            help='Repository to land to')

        self.args = parser.parse_args()
        if self.args.force and self.args.repo != 'try':
            raise GitPusherException('--force can only be used on try')

    def _build_try_args(self):
        args = []
        if self.args.build:
            for build in self.args.build:
                args.extend(['-b', build])

        if self.args.platform:
            for platform in self.args.platform:
                args.extend(['-p', platform])

        if self.args.unittests:
            for unittest in self.args.unittests:
                args.extend(['-u', unittest])

        if self.args.talos:
            for talos in self.args.talos:
                args.extend(['-t', talos])

        if self.args.all_emails:
            args.append('-e')

        if self.args.no_emails:
            args.append('-n')

        if self.args.failure_emails:
            args.append('-f')

        if self.args.mozilla_central:
            args.append('-m')

        return args

    def _cleanup(self):
        if self.tmpdir:
            shutil.rmtree(self.tmpdir)

        if self.patches:
            p = subprocess.Popen(['hg', 'qpop', '-a'], cwd=self.repo)
            p.wait()
            for patch in self.patches:
                patch = os.path.basename(patch)
                p = subprocess.Popen(['hg', 'qdel', patch], cwd=self.repo)
                p.wait()

    def _push_to_try(self):
        sys.stdout.write('running hg try extension...\n')
        args = self._build_try_args()
        p = subprocess.Popen(['hg', 'try'] + args, cwd=self.repo)
        if p.wait():
            raise GitPusherException('hg try failed')

    def _push_to_hg(self):
        # Finish the queue series
        sys.stdout.write('finishing queue series...\n')
        p = subprocess.Popen(['hg', 'qfinish', '-a'], cwd=self.repo)
        if p.wait():
            raise GitPusherException('Could not finish queue series')

        if self.interactive:
            sys.stdout.write('checking outgoing changes...\n')
            p = subprocess.Popen(['hg', 'outgoing'], cwd=self.repo)
            if p.wait():
                raise GitPusherException('Could not determine outgoing changes')

            answer = ''
            while answer.strip().lower() not in ('y', 'ye', 'yes', 'n', 'no'):
                answer = raw_input('Are these changes OK [y/n]? ')

            if answer.strip().lower() in ('n', 'no'):
                raise GitPusherException('Aborting (leaving patch queue intact)')

        # Now we can go around pushing
        sys.stdout.write('running hg push...\n')
        p = subprocess.Popen(['hg', 'push', self.url], cwd=self.repo)
        if p.wait():
            raise GitPusherException('hg push failed')

    def run(self):
        # Make our working directory
        self.tmpdir = tempfile.mkdtemp(prefix='gitland', dir='/tmp')

        if not self.args.force:
            # Ensure there aren't any outstanding changes
            sys.stdout.write('checking git repository...\n')
            p = subprocess.Popen(['git', 'status', '--porcelain', '-z'],
                    stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
            p.wait()
            if p.stdout.read():
                raise GitPusherException('You have uncommitted changes')

        # Get the contents of the patches
        sys.stdout.write('making patches...\n')
        p = subprocess.Popen(['git', 'branchseries', '-o', self.tmpdir])
        if p.wait():
            raise GitPusherException('Could not create patches')

        # Make sure our hg repo doesn't have any outstanding changes or patches
        sys.stdout.write('checking hg repository...\n')
        p = subprocess.Popen(['hg', 'qseries'], stdout=subprocess.PIPE,
                stderr=subprocess.PIPE, cwd=self.repo)
        p.wait()
        if p.stdout.read().strip():
            raise GitPusherException('Hg repo already has mq patches')

        p = subprocess.Popen(['hg', 'status'], stdout=subprocess.PIPE,
                stderr=subprocess.PIPE, cwd=self.repo)
        p.wait()
        if p.stdout.read().strip():
            raise GitPusherException('Hg repo has outstanding changes')

        # Go to our hg repo and update to the latest
        sys.stdout.write('updating hg repository...\n')
        p = subprocess.Popen(['hg', 'pull', '-u'], stdout=subprocess.PIPE,
                stderr=subprocess.PIPE, cwd=self.repo)
        if p.wait():
            raise GitPusherException('Could not check out hg repository')

        # Apply the patches
        sys.stdout.write('applying patches...\n')
        self.patches = glob.glob(os.path.join(self.tmpdir, '*.patch'))
        for patch in self.patches:
            p = subprocess.Popen(['hg', 'qimport', patch], cwd=self.repo)
            if p.wait():
                raise GitPusherException('Could not import patch to hg')
            p = subprocess.Popen(['hg', 'qpush'], cwd=self.repo)
            if p.wait():
                raise GitPusherException('Could not apply patch to hg')

        try:
            if self.args.repo == 'try':
                self._push_to_try()
            else:
                # No patches applied after this point, don't try to pop them
                self.patches = None
                self._push_to_hg()
        finally:
            sys.stdout.write('cleaning up...\n')
            self._cleanup()

        sys.stdout.write('done!\n')

if __name__ == '__main__':
    try:
        t = GitPusher(sys.argv[1:])
        t.run()
    except GitPusherException, e:
        try:
            sys.stderr.write('Working directory at %s\n' % t.tmpdir)
        except:
            sys.stderr.write('No working directory created\n')
        sys.stderr.write('%s\n' % str(e))
        sys.exit(1)
